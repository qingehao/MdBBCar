## 浅入深出的讲解有感FOC

#### 1 电机为啥会转？

##### 1.1 基本转动原理

如下图，最基本的电机模型中，当左右的螺线管中通有电流时，会产生一个磁场，对中间磁铁施加一个力矩，使之旋转，旋转到磁铁内部磁力线与外部磁力线平行时。

但若是想要使其连续转动，便需要再切换外部磁场的方向。如何进行这个切换，接着往下看

<img src=".\image\转动基本原理.png" alt="转动基本原理" style="zoom:80%;" />

##### 1.2 有刷与无刷的基本结构

> 电机中，转动的部分我们称之为转子，固定不动的部分称为定子

有刷直流电机中，定子通常为永磁体，转子通常为线圈。我们依靠固定在转子上的换向器来完成转子磁场方向的切换

<img src=".\image\有刷电机转动.gif" alt="有刷电机转动"  />

无刷直流电机中，定子通常为线圈，转子为永磁铁，依靠外部的电子电路不断的切换定子的磁场方向。

![无刷电机转动](.\image\无刷电机转动.gif)

#### 2 无刷电机的控制原理

##### 2.1 电机控制电路

控制电路如下图，通过改变三组H桥的开关状态来改变电机三线圈的电流流向

<img src=".\image\三相驱动电路.png" alt="三相驱动电路" style="zoom:80%;" />

##### 2.2 六步换向法

<img src=".\image\三相驱动电路ac导通.png" alt="三相驱动电路ac导通" style="zoom:80%;" />

如上图所示，第一组H桥上管导通，第三组H桥下管导通，其电流如图所示，可形成由a指向c的磁场。同理，我们可以得到所有状态下的磁场状态。如下图。

<img src=".\image\六步换向.png" alt="六步换向" style="zoom:80%;" />

在实际中，以上的控制方式是浪费的，因为只有电机的两相导通，另一相没导通，那便损失了另一相的力矩。

我们接着对三组半桥的开关状态进行编码，规定上管导通，下管关闭为1；上管关闭，下管导通为0；上下均导通非法情况；上下均不导通，浪费~

因此，会出现8种组合方式：**000**、**001**、**010**、**011**、**100**、**101**、**110**、**111**

我们通过不断改变定子的磁场方向，转子就像毛驴上吊着一根胡萝卜一样，转起来了。进一步总结：**对电机的控制实际上就是对MOS管开关规律的控制**。而MOS管的开关规律是需要用到单片机程序进行控制的，因此这就引出了我们的**FOC控制算法，FOC控制就是一种对电机运动模型进行抽象化和简化，进而有规律控制各个MOS管开关和通断的过程**。

#### 3 FOC控制算法

<img src=".\image\FOC控制框图.png" alt="FOC控制框图" style="zoom:70%;" />

直接看FOC控制全图会有点懵，里面各种闭环控制，我们先尝试开环让电机旋转起来。

##### 3.1 磁场矢量控制

根据前面所述六步换向法，我们想要使得电机转动起来，只需要循环六种开关状态即可，事实上也确实如此。但样只会让电机步进的转动起来，步进角为60度，如何让电机连续且平滑的转动起来呢？

我们可以直接控制的是电机三相绕组上的电压，通过电压进而控制磁场。所以我们只需要控制三相上电压的大小和方向，就能够控制其所产生的合磁场的方向和大小。

那问题来了，**能够使电机连续转动的三相电压是什么样子呢？**这个很简单，我们转动转子，观测三相上的电压即可。发动机就是发电机。我们可以得到三相上控制电压如下图。

<img src=".\image\三相发电机原理.gif" alt="三相发电机原理" style="zoom:50%;" />

##### 3.2 开环让他转

通过上述分析我们可以知道，通过在电机三相线上施加三个相位差为120°的正弦波形电压，电机就可以转动了。这当然可以，但是这将会变得极其复杂，因此我们在这里引入了clarke变换以及park变换

##### 3.2.1 clarke变换、clarke逆变换

我们现在知道，最终输入到电机相线上的电压是三个相差120度的正弦信号。即

> 虽然控制信号是电压，但是最终起作用的是电流，因此这里以电流进行分析哈

$$
\vec{i_a} = i_mcos(\omega t) \\
\vec{i_b} = i_mcos(\omega t+120°) \\
\vec{i_c} = i_mcos(\omega t-120°) \\
$$

在坐标系上表示如下图，显然这种坐标系是我们不愿意去看到以及处理的，因此我们对其进行了基变换，将其变换到一组正交基上。

<img src=".\image\定子磁场120.png" alt="定子磁场120"  />



说人话就是，投影到了平面直角坐标系上。如下图

<img src=".\image\定子磁场投影.png" alt="定子磁场投影" style="zoom:50%;" />


$$
I_\alpha = i_a - sin30°i_b - cos60°i_c\Longleftrightarrow i_\alpha = i_a - \frac{1}{2}i_b - \frac{1}{2}i_c \\
I_\beta = cos30°i_b-cos30°i_c\Longleftrightarrow i_\beta = \frac{\sqrt{3}}{2}i_b-\frac{\sqrt{3}}{2}i_c \\
$$

表示成矩阵，就是

$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    i_a \\ 
    i_b \\ 
    i_c \\
\end{bmatrix}
$$

**以上就是Clarke变换**。

接下来我们做个例子实际用一下Clarke变换，假设我们A相输入1A电流，A相与α相重合

首先根据基尔霍夫电流定律，我们知道，ia+ib+ic = 0, 我们假定ia = -1A, 则ib = ic = 1/2 A.带入Clarke变换矩阵中


$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    -1 \\ 
    \frac{1}{2} \\ 
    \frac{1}{2} \\
\end{bmatrix}=
\begin{bmatrix}
    -\frac{3}{2} \\
    0 \\
\end{bmatrix}
$$

呀嘿，出现问题了，即使A相与α轴重合，但是由于b,c电流投影的存在，导致反映在α轴上的电流不是-1，而是- 3/2.

因此，引出了**Clarke的等幅值变换**, 2/3就是等幅值变换系数。同样的，也可以得到等功率变化系数 sqrt(2/3)

$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\frac{2}{3}
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    i_a \\ 
    i_b \\ 
    i_c \\
\end{bmatrix}
$$

对于Clarke逆变换，此时我们也不难得出了。在等幅值变换的基础上，我们可以得到如下关系式

$$
I_\alpha = i_a \\
I_\beta = \frac{1}{\sqrt{3}}(2i_b+i_a) \\
$$

进一步的，我们根据KCL定律 i<sub>a</sub>+i<sub>b</sub>+i<sub>c</sub> = 0， 最终可以得到**Clarke逆变换**

$$
i_a = I_\alpha \\
i_b = \frac{\sqrt{3}I_\beta-I_\alpha}{2} \\
i_c = \frac{-I_\alpha-\sqrt{3}I_\beta}{2} \\
$$

##### 3.2.2 Park变换

在Clarke变换中，我们将电机正弦驱动的三相波形变换到了平面直角坐标系中。通过一个简单的推导我们可以得知，转子某一位置必然对应着一个确定ia，ib，ic，也就是对应着一个确定的iα以及iβ。那我们需要让电机转，也就意味着我们要不停的变化iα以及iβ。哦，天呐，这好像不比原来直接控制三相来的简单多少。

仔细想想我们发现，转子的旋转，不就是αβ坐标系的旋转。因此我们将αβ坐标系进行旋转，**这就是Park变换**。

Park变换得到的新的坐标系我们称为dq坐标系，其与αβ坐标系关系如下图。

<img src=".\image\DQ与阿尔法.png" alt="DQ与阿尔法" style="zoom:80%;" />

其中夹角θ，我们称之为电角度。

其数学表达如下

$$
\begin{bmatrix}
    I_q \\
    I_d \\
\end{bmatrix}=
\begin{bmatrix}
    cos\theta & sin\theta \\
    -sin\theta & cos\theta \\
\end{bmatrix}
\begin{bmatrix}
    I_\alpha \\ 
    I_\beta \\
\end{bmatrix}
$$

在实际工程中，电角度可以通过传感器测量得到(霍尔、编码器等得到机械角度进而得到电角度)，因此这是已知的。我们只需通过控制iq和id即可以控制电机啦。事情突然变得好简单。

**iq与id的作用**

<img src=".\image\毛驴.png" alt="毛驴" />

iq决定了产生的力矩大小，id貌似不产生力矩，但是它却可以让毛驴受到的重力小很多。你想想一般是胖子跑的快还是瘦子跑得快。事实上，id的磁场与外部磁场的方向平行，因此它可以加强或者减弱外部磁场。这里不再展开描述。

##### 3.2.3 开环跑起来

##### 机械角度与电角度

电机的极对数就是电机中磁极数，我们知道磁极一般来说都是成对出现。我们把一个N极和S极称为一对磁极，即极对数为1.一般来说，无刷电机中会拥有多对磁极，这会使得力矩更加均匀连续，电机进而转的更加平滑。

在前面Park变换中，我们需要得到此时转子相对于外磁场的角度。我们可以轻松的得到，此时转子的位置即机械角度。那么机械角度和电角度有什么关系呢。

转子每转过一对磁极，便会产生一个完整周期的正弦信号，当转完机械角度的一圈，其所经历的电角度就是 机械角度 * 极对数。这无需画图，仅凭想象便可得到，因此这里就不放图了。 所以，**电角度 = 机械角度 X 极对数**。

##### SPWM

我们给到电机相线上的信号，是正弦电压信号，正弦信号是一种连续的模拟信号。而给到MOS管的是离散的开关信号，那么我们需要如何得到这个正弦信号呢。

**冲量相等但形状不同的窄脉冲作用在具有惯性的环节上，其效果相同**。**说人话，不同形状的窄脉冲，相同时间内对于时间的积分相同，效果相同。**

<img src=".\image\SPWM.png" alt="SPWM" style="zoom:50%;" />

电机的线圈本质上是一个电感，其具有储能作用，也就是说其是一个惯性环节；MCU最容易产生的就是PWM波形了，因此我们可以在PWM的基础上，不断的改变占空比，来模拟正弦波。这就是SPWM，如下图所示。

<img src=".\image\SPWM_1.png" alt="SPWM_1" />

**让它转起来吧！**

<img src=".\image\开环.png" alt="开环" />

如上图所示，我们可以通过程序直接生成旋转的电角度以及给定一个力矩Iq让电机实现转动。代码如下：



#### 3.3 FOC的三环：电流环、速度环、位置环

看到这里，你已经明白了FOC控制的基本原理，此时再回头看这张图。对于FOC中的三个闭环，这里便不再过多赘述。

<img src=".\image\FOC控制框图.png" alt="FOC控制框图" style="zoom:80%;" />

通过电流环，我们可以精确的控制电机的力矩。

通过速度环，我们可以精确的控制电机的转速。

通过位置环，我们可以精确的控制电机的位置。

#### 3.4 SVPWM

##### 3.4.1 SVPWM Vs SPWM

在前面的FOC框图中，其在逆Park变换后，给到了SVPWM模块，再给到了半桥驱动电路。这里的SVPWM与我们前面所述的SPWM有何不同？

**我们先来分析一下SPWM**

SPWM在时域上可以表现为三组相位相差120°的正弦波，如下图所示

<img src=".\image\SVPWM_1.png" alt="SVPWM_1" style="zoom:80%;" />

相信聪明的你已经发现了端倪，尽管每相上的电压都占满的电压区间，但是最终形成电流的电压差却达不到满幅值电压，只能达到满幅值电压的86.6%。

相信聪明的你此时也能够给出解决办法了，那我只需要给每相电压乘以一个系数 100/86.6 就可以了呗。

但是这样子会导致电压会超过最大供电能力. 

我们又可以在超过最大电压将整条曲线向下移动，低于最小电压时，曲线上移。

换句话说，我们给其叠加了一个三角波，如下图所述。

<img src=".\image\SVPWM_2.png" alt="SVPWM_2" style="zoom:80%;" />

<img src=".\image\SVPWM_3.png" alt="SVPWM_3" style="zoom:80%;" />

SVPWM可以很好的利用供电电压范围。

##### 3.4.2 SVPWM的基本数学推导

让我们回到最基本的电机控制方法 --- 六步换向法。

我们知道电机的三相线通过三组MOS管进行控制，这三组MOS共有8种开关状态，其中6种可以产生力矩，使得电机转动，这六种开关状态表示着线圈磁场的六种方向，是我们可以直接得到的六个基本磁场矢量，我们将其矢量形式表示如下图。可分为六个扇区

<img src=".\image\SVPWM_4.png" alt="SVPWM_4" />

我们以V4和V6矢量所夹的第一扇区进行研究，我们现有两个基本矢量V4和V6，如果我以V4和V6来进行控制，那我们的电机将会称为一个步进电机，我们想要得到V4和V6两个矢量中间的任意矢量，来提高我们我们的分辨率，如下图。这是SVPWM实现的核心思路。

<img src=".\image\SVPWM_5.png" alt="SVPWM_5" style="zoom:67%;" />

但我们的MOS管只有六种开关状态，那我们该如何得到V4和V6之间的矢量呢？聪明的你可能马上想到了SPWM的实现原理。

<img src=".\image\SVPWM_6.png" alt="SVPWM_6" style="zoom:80%;" />

V4和V6矢量做工时间为
$$
T_1 = T*|V_\delta|*sin(60°-\alpha) \\
T_2 = T*|V_\delta|*sin(\alpha) \\
$$
不做功时间便是
$$
T_0 = T-T_1-T_2
$$
其中T是控制周期的长短，|Vδ|即所需合成矢量的模，即产生的磁场强度，它与我们的Iq相关。

因此对于V4和V6矢量来说，要和Vδ，那么其三相做工时间就是 T1*(1,0,0) = (T1,0,0); T2*(1,1,0) = (T2, T2, 0), 分别对应ABC三相的做工时间。因此，三相的做工时间分别为 Ta = T1+T2；Tb = T2；Tc = 0。但别忘了，我们还有不做功的时间，对于三组H桥来说，还有两种状态对应着不做功，即(1, 1, 1)和(0, 0, 0), 我们将T0分配给这两个状态。因此我们最终可以得到ABC三相的通电时间为 Ta = T1+T2+T0/2; Tb = T2+T0/2; Tc = T0/2。

> 分配不做功时间，也可以缓解一个周期内MOS管的开关压力

同理，我们可以得到SVPWM在其他扇区内的三相通电时间如下表

| 扇区 | Ta           | Tb           | Tc           |
| ---- | ------------ | ------------ | ------------ |
| Ⅰ    | *T1+T2+T0/2* | *T2+T0/2*    | T0/2         |
| Ⅱ    | *T1+T0/2*    | *T1+T2+T0/2* | T0/2         |
| Ⅲ    | *T0/2***     | *T1+T2+T0/2* | *T2+T0/2*    |
| Ⅳ    | *T0/2*       | *T1+T0/2*    | *T1+T2+T0/2* |
| Ⅴ    | *T2+T0/2*    | *T0/2*       | *T1+T2+T0/2* |
| Ⅵ    | *T1+T2+T0/2* | *T0/2*       | *T1+T0/2*    |

接下来我们进一步推导Iq与Vδ的关系，毕竟我们输入的是Iq

<img src=".\image\SVPWM_7.png" alt="SVPWM_7" style="zoom:80%;" />

假设我们的电源电压为Udc，Vδ与V4重合且达到V4的最大值（也就是电源电压Udc），此时MOS管状态为(1,0,0)。通过KVL定律，我们可以知道，此时三相上电压分别为
$$
u_a = \frac{2}{3}U_{dc}; u_b = -\frac{1}{3}U_{dc}; u_c = -\frac{1}{3}U_{dc}
$$
我们知道这三个矢量的夹角为120°，因此我们可以求得这三个矢量的和向量的模长

<img src=".\image\SVPWM_8.png" alt="SVPWM_8" style="zoom:80%;" />
$$
\sqrt{(u_a+u_b+u_c)^2} \\
= |u_a|^2 + |u_b|^2 + |u_c|^2 + 2|u_a||u_b|cos60°+2|u_a||u_c|cos60°+2|u_b||u_c|cos120° \\
= U_{dc} = |V\delta|
$$
推导到这里，你会发现多出了Udc，这时候我们可以尝试建立Udc与前面T1，T2的关系。

我们可以对前面T1 T2的等式进一步推广，得到如下式子：
$$
\frac{\frac{T_1}{T}|V6|}{sin(60°-\alpha)}=\frac{\frac{T_2}{T}|V4|}{sin(\alpha)}=\frac{|V\delta|}{sin(120°)} \\
|V4| = |V6| = U_{dc} \\
T_1 = \frac{2\sqrt{3}}{3}\frac{|V\delta|}{U_{dc}}Tsin(60°-\alpha) \\
T_2 = \frac{2\sqrt{3}}{3}\frac{|V\delta|}{U_{dc}}Tsin(\alpha) \\
$$

> 任意平面三角形中，各边和它所对应角的正弦值的比值相等

在Park逆变换中，我们把Uq和Ud转换成了Uα和Uβ，这个过程只是旋转变换，因此前后的模长是相同的，因此我们可以得到如下等式
$$
\sqrt{U_q^2+U_d^2}=\sqrt{U_\alpha^2+U_\beta^2} = \frac{2}{3}\sqrt{u_a^2+u_b^2+u_c^2}
$$
OK,到了这里，我们终于凑齐了公式，可以推导出T1 T2与Uq以及Ud的关系了。我在这里直接写答案
$$
T_1 = \frac{2\sqrt{3}}{3}\frac{|V\delta|}{U_{dc}}Tsin(60°-\alpha) = \sqrt{3}\frac{\sqrt{U_q^2+U_d^2}}{U_{dc}}Tsin(60°-\alpha) \\
T_2 = \frac{2\sqrt{3}}{3}\frac{|V\delta|}{U_{dc}}Tsin(\alpha)=\sqrt{3}\frac{\sqrt{U_q^2+U_d^2}}{U_{dc}}Tsin(\alpha)  \\
$$

> 具体实现时，还需进行扇区的判断，非常简单 （电角度/60°+1）

#### 4 FOC的工程实现

在前面，我们已经基本上弄清楚了FOC控制的基本原理，然而纸上得来终觉浅，在我实际工程实现过程中仍然遇到了不少难题，以下简单列举几种。

##### 4.1 H桥驱动电路

4.1.1 栅极驱动的选择

4.1.2 上下均为NMOS，上管的控制浮地了呀

4.1.3 怎么给我炸管了

4.1.4 电机驱动的di/dt太高，储能电容要靠近哪里放置

4.1.5 功率地与模拟地的单点连接

##### 4.2 电流的采样

4.2.1 电流的采样位置选择

4.2.2 电流采样的滤波

4.2.3 何为PWM抑制运放？

4.2.4 电流采样电阻的选择

##### 4.3 机械角度的获取

4.3.1 有钱我上磁编码器

##### 4.4 抗齿槽转矩



#### 5 总结
