## 浅入深出的讲解有感FOC

#### 1 电机为啥会转？

##### 1.1 基本转动原理

如下图，最基本的电机模型中，当左右的螺线管中通有电流时，会产生一个磁场，对中间磁铁施加一个力矩，使之旋转，旋转到磁铁内部磁力线与外部磁力线平行时。

但若是想要使其连续转动，便需要再切换外部磁场的方向。如何进行这个切换，接着往下看

<img src=".\image\转动基本原理.png" alt="转动基本原理" style="zoom:80%;" />

##### 1.2 有刷与无刷的基本结构

> 电机中，转动的部分我们称之为转子，固定不动的部分称为定子

有刷直流电机中，定子通常为永磁体，转子通常为线圈。我们依靠固定在转子上的换向器来完成转子磁场方向的切换

<img src=".\image\有刷电机转动.gif" alt="有刷电机转动"  />

无刷直流电机中，定子通常为线圈，转子为永磁铁，依靠外部的电子电路不断的切换定子的磁场方向。

![无刷电机转动](.\image\无刷电机转动.gif)

#### 2 无刷电机的控制原理

##### 2.1 电机控制电路

控制电路如下图，通过改变三组H桥的开关状态来改变电机三线圈的电流流向

<img src=".\image\三相驱动电路.png" alt="三相驱动电路" style="zoom:80%;" />

##### 2.2 六步换向法

<img src=".\image\三相驱动电路ac导通.png" alt="三相驱动电路ac导通" style="zoom:80%;" />

如上图所示，第一组H桥上管导通，第三组H桥下管导通，其电流如图所示，可形成由a指向c的磁场。同理，我们可以得到所有状态下的磁场状态。如下图。

<img src=".\image\六步换向.png" alt="六步换向" style="zoom:80%;" />

在实际中，以上的控制方式是浪费的，因为只有电机的两相导通，另一相没导通，那便损失了另一相的力矩。

我们接着对三组半桥的开关状态进行编码，规定上管导通，下管关闭为1；上管关闭，下管导通为0；上下均导通非法情况；上下均不导通，浪费~

因此，会出现8种组合方式：**000**、**001**、**010**、**011**、**100**、**101**、**110**、**111**

我们通过不断改变定子的磁场方向，转子就像毛驴上吊着一根胡萝卜一样，转起来了。进一步总结：**对电机的控制实际上就是对MOS管开关规律的控制**。而MOS管的开关规律是需要用到单片机程序进行控制的，因此这就引出了我们的**FOC控制算法，FOC控制就是一种对电机运动模型进行抽象化和简化，进而有规律控制各个MOS管开关和通断的过程**。

#### 3 FOC控制算法

<img src=".\image\FOC控制框图.png" alt="FOC控制框图" style="zoom:80%;" />

直接看FOC控制全图会有点懵，里面各种闭环控制，我们先尝试开环让电机旋转起来。

##### 3.1 磁场矢量控制

根据前面所述六步换向法，我们想要使得电机转动起来，只需要循环六种开关状态即可，事实上也确实如此。但样只会让电机步进的转动起来，步进角为60度，如何让电机连续且平滑的转动起来呢？

我们可以直接控制的是电机三相绕组上的电压，通过电压进而控制磁场。所以我们只需要控制三相上电压的大小和方向，就能够控制其所产生的合磁场的方向和大小。

那问题来了，**能够使电机连续转动的三相电压是什么样子呢？**这个很简单，我们转动转子，观测三相上的电压即可。发动机就是发电机。我们可以得到三相上控制电压如下图。

<img src=".\image\三相发电机原理.gif" alt="三相发电机原理" style="zoom:50%;" />

##### 3.2 开环让他转

通过上述分析我们可以知道，通过在电机三相线上施加三个相位差为120°的正弦波形电压，电机就可以转动了。这当然可以，但是这将会变得极其复杂，因此我们在这里引入了clarke变换以及park变换

##### 3.2.1 clarke变换、clarke逆变换

我们现在知道，最终输入到电机相线上的电压是三个相差120度的正弦信号。即

> 虽然控制信号是电压，但是最终起作用的是电流，因此这里以电流进行分析哈

$$
\vec{i_a} = i_mcos(\omega t) \\
\vec{i_b} = i_mcos(\omega t+120°) \\
\vec{i_c} = i_mcos(\omega t-120°) \\
$$

在坐标系上表示如下图，显然这种坐标系是我们不愿意去看到以及处理的，因此我们对其进行了基变换，将其变换到一组正交基上。

<img src=".\image\定子磁场120.png" alt="定子磁场120"  />



说人话就是，投影到了平面直角坐标系上。如下图

<img src=".\image\定子磁场投影.png" alt="定子磁场投影" style="zoom:50%;" />


$$
I_\alpha = i_a - sin30°i_b - cos60°i_c\Longleftrightarrow i_\alpha = i_a - \frac{1}{2}i_b - \frac{1}{2}i_c \\
I_\beta = cos30°i_b-cos30°i_c\Longleftrightarrow i_\beta = \frac{\sqrt{3}}{2}i_b-\frac{\sqrt{3}}{2}i_c \\
$$

表示成矩阵，就是

$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    i_a \\ 
    i_b \\ 
    i_c \\
\end{bmatrix}
$$

**以上就是Clarke变换**。

接下来我们做个例子实际用一下Clarke变换，假设我们A相输入1A电流，A相与α相重合

首先根据基尔霍夫电流定律，我们知道，ia+ib+ic = 0, 我们假定ia = -1A, 则ib = ic = 1/2 A.带入Clarke变换矩阵中


$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    -1 \\ 
    \frac{1}{2} \\ 
    \frac{1}{2} \\
\end{bmatrix}=
\begin{bmatrix}
    -\frac{3}{2} \\
    0 \\
\end{bmatrix}
$$

呀嘿，出现问题了，即使A相与α轴重合，但是由于b,c电流投影的存在，导致反映在α轴上的电流不是-1，而是- 3/2.

因此，引出了**Clarke的等幅值变换**, 2/3就是等幅值变换系数。同样的，也可以得到等功率变化系数 sqrt(2/3)

$$
\begin{bmatrix}
    I_\alpha \\
    I_\beta \\
\end{bmatrix}=
\frac{2}{3}
\begin{bmatrix}
    1 & -\frac{1}{2} & -\frac{1}{2} \\
    0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
\end{bmatrix}
\begin{bmatrix}
    i_a \\ 
    i_b \\ 
    i_c \\
\end{bmatrix}
$$

对于Clarke逆变换，此时我们也不难得出了。在等幅值变换的基础上，我们可以得到如下关系式

$$
I_\alpha = i_a \\
I_\beta = \frac{1}{\sqrt{3}}(2i_b+i_a) \\
$$

进一步的，我们根据KCL定律 i<sub>a</sub>+i<sub>b</sub>+i<sub>c</sub> = 0， 最终可以得到**Clarke逆变换**

$$
i_a = I_\alpha \\
i_b = \frac{\sqrt{3}I_\beta-I_\alpha}{2} \\
i_c = \frac{-I_\alpha-\sqrt{3}I_\beta}{2} \\
$$

##### 3.2.2 Park变换

在Clarke变换中，我们将电机正弦驱动的三相波形变换到了平面直角坐标系中。通过一个简单的推导我们可以得知，转子某一位置必然对应着一个确定ia，ib，ic，也就是对应着一个确定的iα以及iβ。那我们需要让电机转，也就意味着我们要不停的变化iα以及iβ。哦，天呐，这好像不比原来直接控制三相来的简单多少。

仔细想想我们发现，转子的旋转，不就是αβ坐标系的旋转。因此我们将αβ坐标系进行旋转，**这就是Park变换**。

Park变换得到的新的坐标系我们称为dq坐标系，其与αβ坐标系关系如下图。

<img src=".\image\DQ与阿尔法.png" alt="DQ与阿尔法" style="zoom:80%;" />

其中夹角θ，我们称之为电角度。

其数学表达如下

$$
\begin{bmatrix}
    I_q \\
    I_d \\
\end{bmatrix}=
\begin{bmatrix}
    cos\theta & sin\theta \\
    -sin\theta & cos\theta \\
\end{bmatrix}
\begin{bmatrix}
    I_\alpha \\ 
    I_\beta \\
\end{bmatrix}
$$

在实际工程中，电角度可以通过传感器测量得到(霍尔、编码器等得到机械角度进而得到电角度)，因此这是已知的。我们只需通过控制iq和id即可以控制电机啦。事情突然变得好简单。

**iq与id的作用**

<img src=".\image\毛驴.png" alt="毛驴" />

iq决定了产生的力矩大小，id貌似不产生力矩，但是它却可以让毛驴受到的重力小很多。你想想一般是胖子跑的快还是瘦子跑得快。事实上，id的磁场与外部磁场的方向平行，因此它可以加强或者减弱外部磁场。这里不再展开描述。

##### 3.2.3 开环跑起来

##### 机械角度与电角度

##### SPWM

<img src=".\image\开环.png" alt="开环" />

#### 3.3 FOC的三环：电流环、速度环、位置环

#### 3.4 SVPWM

##### 3.4.1 SVPWM Vs SPWM

##### 3.4.2 SVPWM的基本推导

#### 4 FOC的工程实现

##### 4.1 H桥驱动电路

##### 4.2 电流的采样

##### 4.3 机械角度的获取

##### 4.4 抗齿槽转矩

#### 5 总结
